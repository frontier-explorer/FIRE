<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>追加投資</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .instruction-box {
            background-color: #f0f8ff;
            border-left: 5px solid #3498db;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .tuika-item {
            background: #fff;
            padding: 15px;
            border: 1px solid #e0eaf3;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .input-group label {
            margin-bottom: 0;
            white-space: nowrap;
        }
        .input-group input, .input-group select {
            width: auto;
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .tuika-item .remove-btn {
            background-color: #e74c3c;
            color: #fff;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 14px;
            margin-top: 10px;
        }
        /* エラー入力時のスタイル */
        .error-input {
            border: 2px solid #e74c3c !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>追加投資</h1>
            <p>シミュレーション期間中に一度だけ行われる追加投資イベントを設定します。</p>
        </header>

        <main>
            <div class="input-section">
                <h2>追加投資イベント一覧</h2>
                
                <div class="instruction-box">
                    <p>💡 <strong>入力方法:</strong></p>
                    <ul>
                        <li>**追加投資年月（年/月）:** 追加投資が**一回だけ**行われるタイミングを設定します。</li>
                        <li>**投資額:** その月に一回投資する金額（円）を入力します。</li>
                        <li>**0年0月または0年1月:** どちらも「シミュレーション開始月」を意味します。</li>
                        <li>**【重要】売買価額について:** このシミュレーションでは、設定された月の**月初（前月末の終値）**の価額で売買が行われます。その月の市場変動の影響を受ける前の価額が適用されます。</li>
                    </ul>
                </div>

                <div id="tuikaContainer">
                    </div>
                
                <div class="form-actions">
                    <button id="addTuikaBtn" type="button" class="nav-button">投資イベントを追加</button>
                    <button id="saveTuikaBtn" class="save-button">設定を保存</button>
                </div>
            </div>

            <div class="back-link">
                <a href="index.html" class="nav-button">メイン画面に戻る</a>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tuikaContainer = document.getElementById('tuikaContainer');
            const addTuikaBtn = document.getElementById('addTuikaBtn');
            const saveTuikaBtn = document.getElementById('saveTuikaBtn');

            // stocks.htmlで設定された銘柄リストを取得
            const appData = JSON.parse(localStorage.getItem('fireSimulatorData')) || {};
            const stocks = appData.stocks || [];

            // 銘柄選択用のオプションHTMLを生成
            const generateStockOptions = (selectedValue = '') => {
                let options = stocks.map(stock => 
                    `<option value="${stock.Meigara}" ${stock.Meigara === selectedValue ? 'selected' : ''}>${stock.Meigara}</option>`
                ).join('');
                // 銘柄が一つもない場合は選択肢を無効化
                if (stocks.length === 0) {
                    options = '<option value="" disabled selected>銘柄が登録されていません</option>';
                }
                return options;
            };

            // 数値をカンマ区切りで表示し、変更時にカンマを自動挿入するイベントを設定
            const setupAmountInput = (inputElement) => {
                const initialValue = inputElement.value;
                if (initialValue && !isNaN(parseInt(initialValue.replace(/,/g, '')))) {
                    inputElement.value = window.formatNumber(parseInt(initialValue));
                }

                inputElement.addEventListener('blur', (e) => {
                    const value = e.target.value.replace(/,/g, '');
                    if (!isNaN(value) && value !== '') {
                        e.target.value = window.formatNumber(parseInt(value, 10));
                    }
                });

                inputElement.addEventListener('focus', (e) => {
                    e.target.value = e.target.value.replace(/,/g, '');
                });
            };

            // 投資アイテムの番号を更新する
            const updateTuikaNumbers = () => {
                document.querySelectorAll('.tuika-item h3').forEach((header, index) => {
                    header.textContent = `追加投資イベント #${index + 1}`;
                });
            };

            // 追加投資アイテムのHTMLを生成・DOMに追加
            const createTuikaItem = (data = { month: 0, meigara: stocks.length > 0 ? stocks[0].Meigara : '', amount: 0 }) => {
                const year = Math.floor(data.month / 12);
                const month = (data.month % 12) + 1; // 1-12月に戻す
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('tuika-item');
                
                // HTML生成
                itemDiv.innerHTML = `
                    <h3>追加投資イベント</h3>
                    <div class="input-group">
                        <label>**追加投資年月（年/月）:**</label>
                        <input type="number" class="tuika-year" value="${year}" min="0" required placeholder="年"> / 
                        <input type="number" class="tuika-month" value="${month}" min="1" max="12" required placeholder="月">
                    </div>
                    <div class="input-group">
                        <label>銘柄:</label>
                        <select class="tuika-meigara" required ${stocks.length === 0 ? 'disabled' : ''}>
                            ${generateStockOptions(data.meigara)}
                        </select>
                    </div>
                    <div class="input-group">
                        <label>投資額（円）:</label>
                        <input type="text" class="tuika-amount" value="${data.amount}" required>
                    </div>
                    <button type="button" class="nav-button remove-btn">削除</button>
                `;

                const amountInput = itemDiv.querySelector('.tuika-amount');
                setupAmountInput(amountInput); // 投資額入力欄のフォーマットを設定

                const removeBtn = itemDiv.querySelector('.remove-btn');
                removeBtn.addEventListener('click', () => {
                    itemDiv.remove();
                    updateTuikaNumbers();
                });

                tuikaContainer.appendChild(itemDiv);
                updateTuikaNumbers();
            };

            const addTuikaItem = () => {
                createTuikaItem();
            };

            // データを読み込み、表示する関数
            const loadTuika = () => {
                tuikaContainer.innerHTML = '';
                const appData = JSON.parse(localStorage.getItem('fireSimulatorData')) || {};
                const tuikaData = appData.tuika || [];

                if (tuikaData.length === 0) {
                    addTuikaItem(); // データがない場合は初期アイテムを一つ追加
                } else {
                    tuikaData.forEach(data => createTuikaItem(data));
                }
            };
            
            // --- イベントリスナーの設定 ---
            addTuikaBtn.addEventListener('click', addTuikaItem);

            saveTuikaBtn.addEventListener('click', () => {
                const tuikaData = [];
                let isValid = true;
                
                document.querySelectorAll('.tuika-item').forEach(itemDiv => {
                    const yearInput = itemDiv.querySelector('.tuika-year');
                    const monthInput = itemDiv.querySelector('.tuika-month');
                    const meigaraInput = itemDiv.querySelector('.tuika-meigara');
                    const amountInput = itemDiv.querySelector('.tuika-amount');

                    const year = parseInt(yearInput.value, 10);
                    const month = parseInt(monthInput.value, 10);
                    const meigara = meigaraInput.value;
                    const amount = parseInt(amountInput.value.replace(/,/g, ''), 10); // カンマを削除して数値に変換
                    
                    const totalMonths = year * 12 + (month - 1); // 0-11の月に変換

                    if (isNaN(year) || isNaN(month) || isNaN(amount) || year < 0 || month < 1 || month > 12 || amount < 0 || !meigara) {
                        isValid = false;
                        yearInput.classList.add('error-input');
                        monthInput.classList.add('error-input');
                        amountInput.classList.add('error-input');
                        meigaraInput.classList.add('error-input');
                        return; // forEachから抜ける
                    } else {
                        // エラーが解消された場合はスタイルを元に戻す
                        yearInput.classList.remove('error-input');
                        monthInput.classList.remove('error-input');
                        amountInput.classList.remove('error-input');
                        meigaraInput.classList.remove('error-input');
                    }
                    
                    tuikaData.push({
                        month: totalMonths,
                        meigara: meigara,
                        amount: amount
                    });
                });

                if (!isValid) {
                    alert('全ての項目に正しい数値を入力してください。年数は0以上、月は1から12までの数値、投資額は0以上の数値を入力し、銘柄を選択してください。');
                    return;
                }

                // 総月数でソートして保存
                const sortedTuikaData = tuikaData.sort((a, b) => a.month - b.month); 
                
                const appData = JSON.parse(localStorage.getItem('fireSimulatorData')) || {}; 
                appData.tuika = sortedTuikaData;
                localStorage.setItem('fireSimulatorData', JSON.stringify(appData));
                alert('追加投資の設定が保存されました！');
                
                // 保存後に再ロードして表示を更新（カンマフォーマットの再適用など）
                loadTuika();
            });

            loadTuika();
        });
    </script>
</body>
</html>