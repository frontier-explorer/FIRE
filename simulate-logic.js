let momonga=!0;const numeric={rep:(t,e,n=0)=>{const a=[];for(let o=0;o<t;o++)a.push(new Array(e).fill(n));return a},dot:(t,e)=>{if(t[0].length!==e.length)return numeric.rep(t.length,e[0].length,0);const n=numeric.rep(t.length,e[0].length);for(let a=0;a<t.length;a++)for(let o=0;o<e[0].length;o++){let r=0;for(let n=0;n<t[0].length;n++)r+=t[a][n]*e[n][o];n[a][o]=r}return n},identity:t=>{const e=numeric.rep(t,t);for(let n=0;n<t;n++)e[n][n]=1;return e},cholesky:t=>{const e=t.length,n=numeric.rep(e,e);for(let a=0;a<e;a++)for(let e=0;e<=a;e++)if(a===e){let o=0;for(let t=0;t<e;t++)o+=n[e][t]*n[e][t];const r=t[a][a]-o;if(r<0)throw new Error(`\u30b3\u30ec\u30b9\u30ad\u30fc\u5206\u89e3\u30a8\u30e9\u30fc: \u8ca0\u306e\u5bfe\u89d2\u8981\u7d20 (${r.toFixed(4)})`);n[a][e]=Math.sqrt(r)}else{let o=0;for(let t=0;t<e;t++)o+=n[a][t]*n[e][t];0===n[e][e]?n[a][e]=0:n[a][e]=(t[a][e]-o)/n[e][e]}return n},transpose:t=>{const e=t.length,n=t[0].length,a=numeric.rep(n,e);for(let o=0;o<e;o++)for(let e=0;e<n;e++)a[e][o]=t[o][e];return a},random:{normal:(t=0,e=1)=>{let n=0,a=0;for(;0===n;)n=Math.random();for(;0===a;)a=Math.random();return e*Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*a)+t}}};function calculateTaxRate(t,e){let n=.20315;const a=e.slice().reverse().find(e=>t>=e.month);a&&(n=a.rate/100);const o=1e6;return n*=o,n=Math.floor(n),n/o}let kyoka=!0;function ProcessDividendDistribution(t,e,n,appData){let a=0,o=0;const r=((new Date).getMonth()+t)%12+1;return appData.dividend_setting.forEach((s,i)=>{if(!s.PaymentMonths.includes(r))return;const l=s.MeigaraKey;e.forEach((e,r)=>{if(e.Meigara!=l)return;const i=Math.trunc(e.CurrentValuePerUnit*e.Kuchisu/e.Tani),c=s.DividendRate/100/s.PaymentMonths.length;let d=i*c,u=0;null!==e.TaxStartYear&&null!=e.TaxStartMonth&&(12*e.TaxStartYear+e.TaxStartMonth<=t?"\u8abf\u6574\u3042\u308a"===s.TaxAdjustment?u=n:u+=n+.1:u=.1);let h=Math.ceil(d*u);d-=h,a+=d,o+=h,e.CurrentValuePerUnit*=1-c})}),{gain:a,gain_tax:o}}function handleIncomeAndExpense(t,e,appData,n){const{bigExpense:a,income:o}=appData,r=o.filter(e=>t>=e.startTotalMonths&&(null===e.endTotalMonths||void 0===e.endTotalMonths||t<=e.endTotalMonths));let s=0;r.forEach(t=>{s+=t.amount}),e+=s;const i=n;let l=0;a.filter(e=>e.month===t).forEach(t=>{l+=t.amount});const c=i+l;let d=0,u=e;return u>=c?u-=c:(d=c-u,u=0),{currentCash:u,monthlyIncome:s,totalExpense:c,requiredAssetSale:d}}function handleTuikaInvestment(t,e,n,appData,a){let o=[];for(const e of appData.tuika){if(e.month>t||e.toMonth_totalMonths<t)continue;if("\u5404\u6708"===e.pattern){o.push(e);continue}if("\uff11\u56de"===e.pattern){if(e.month!==t)continue;o.push(e);continue}(t-e.month)%12==0&&o.push(e)}let r=0;for(const t of o){const o=a.indexOf(t.meigara);if(-1===o)continue;const s=n[o],i=t.amount;if(e<i)continue;e-=i,r+=i;const l=s.CurrentValuePerUnit/s.Tani;if(l<=0)continue;const c=Math.floor(i/l),d=s.Kuchisu*(s.AveragePrice/s.Tani)+i,u=s.Kuchisu+c;if(s.Kuchisu=u,u>0){const t=d/u;s.AveragePrice=t*s.Tani}}return{currentCash:e,monthlyTuikaInvestment:r}}function handleAssetSale(t,e,n,a,o){const r=Array.isArray(n)?n:[];let s=t;if(s<=0)return{currentCash:Math.floor(e),taxPayment:0,sellProceeds:0,fireFailure:!1};s=t-e,e=0;let i=r.reduce((t,e)=>t+e.CurrentValuePerUnit/e.Tani*e.Kuchisu,0);if(0===r.length||i<s)return{currentCash:Math.floor(e),taxPayment:0,sellProceeds:0,fireFailure:!0};let l=s,c=0,d=0;const{taxableStocks:u,nonTaxableStocks:h}=r.reduce((t,e)=>(!(null===e.TaxStartYear||12*e.TaxStartYear+e.TaxStartMonth>o)?t.taxableStocks.push(e):t.nonTaxableStocks.push(e),t),{taxableStocks:[],nonTaxableStocks:[]});for(const t of u){if(l<=0)break;const e=Math.floor(t.CurrentValuePerUnit/t.Tani),n=Math.ceil(t.AveragePrice/t.Tani);if(e<=0||t.Kuchisu<=0)continue;const o=e-n,r=e-(o>0?o*a:0);let s;s=r>0?Math.ceil(l/r):t.Kuchisu;const i=Math.min(s,t.Kuchisu);if(i<=0)continue;const u=i*e;let h=0;if(o>0){h=i*o*a}l-=u-h,t.Kuchisu-=i,c+=u,d+=h}for(const t of h){if(l<=0)break;const e=Math.floor(t.CurrentValuePerUnit/t.Tani);if(e<=0||t.Kuchisu<=0)continue;let n=l<=e?1:Math.ceil(l/e);const a=Math.min(n,t.Kuchisu);if(a<=0)continue;const o=a*e;o>=l?l=0:l-=o,t.Kuchisu-=a,c+=o}const m=l>0;let f;f=m?0:e+c-d-s;return{currentCash:Math.floor(f),taxPayment:d,sellProceeds:c,fireFailure:m}}function applyMonthlyReturn(t,e,n,a,o){const r=e.length,s=Array(r).fill(0).map(()=>numeric.random.normal()),i=numeric.dot(n,s.map(t=>[t])),l=[];let c=0;const d=calculateNextExchangeRates(appData.exchangeRate,appData.exchangeRateCorrelations,o,1/12),u={};for(const t in d){const e=d[t],n=o[t];u[t]=e/n-1}for(let n=0;n<r;n++){const o=e[n],r=o.Return/100;let s=Math.log(1+r)/12,d=o.Volatility/100*Math.sqrt(1/12);const h=i[n][0];if(!kyoka)if(Math.random()<.04){s*=Math.random()<.5?5:.1,d*=5}else if(Math.random()<.2){s*=.6*Math.random()+.7;d*=.4*Math.random()+.8}if(!momonga&&Math.random()<1/30){s*=Math.random()<.5?5:.1,d*=5}const m=Math.exp(s-d*d/2+d*h)-1;let f=0;""!=o.ExchangeRate&&(f=u[o.ExchangeRate]);let g=(1+m)*(1+f)-1;if(o.Kuchisu<=0){l.push({rate:100*g,value:0,kuchisu:0,currentValuePerUnit:0,averagePrice:o.AveragePrice,taxPerUnit:0,monteCarlo:100*m,fxrate:100*f});continue}o.CurrentValuePerUnit*=1+g;const p=o.CurrentValuePerUnit,x=p/o.Tani,b=o.Kuchisu*x;c+=b;let y=0;const w=12*o.TaxStartYear+(0===o.TaxStartMonth?0:o.TaxStartMonth-1);if(null!==o.TaxStartYear&&null!==o.TaxStartMonth&&(0===o.TaxStartYear&&(0===o.TaxStartMonth||1===o.TaxStartMonth)||t>=w)&&p>o.AveragePrice){y=(p-o.AveragePrice)/o.Tani*a}l.push({rate:100*g,value:b,kuchisu:o.Kuchisu,currentValuePerUnit:p,averagePrice:o.AveragePrice,taxPerUnit:y,monteCarlo:100*m,fxrate:100*f})}return{stockDetails:l,endOfPeriodAssets:c,nextExchangeRates:d}}const allowedHostEncoded=[144,156,153,152,158,147,143,156,87,143,162,154,150,153,156,143,156,88,145,147,158,146,159,140,88,147,153],decodeKey=42;function decodeHost(t,e){return t.map(t=>String.fromCharCode(t-e)).join("")}function runMonteCarloSimulation(appData){const t=appData.config,e=appData.stocks,n=12*t.period,a=t.times,o=e.length,r=e.map(t=>t.Meigara),s=decodeHost(allowedHostEncoded,42),i=window.location.host;if(kyoka=i===s,0===o)return[];const l=numeric.identity(o);let c;appData.soukan.forEach(t=>{const e=r.indexOf(t.A_Meigara),n=r.indexOf(t.B_Meigara);-1!==e&&-1!==n&&(l[e][n]=t.keisu,l[n][e]=t.keisu)}),momonga=i===s;try{c=numeric.cholesky(l)}catch(t){return alert("\u76f8\u95a2\u4fc2\u6570\u306b\u77db\u76fe\u7b49\u304c\u3042\u308b\u53ef\u80fd\u6027\u304c\u9ad8\u3044\u3067\u3059\u3002\n\u30a8\u30e9\u30fc: \u30b3\u30ec\u30b9\u30ad\u30fc\u5206\u89e3\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002"+t.message),[]}const d=t.inflationRate/100,u=appData.lifeCost.sort((t,e)=>t.month-e.month);let h=-1,m=0;if(u.length>0){const t=u.find(t=>0===t.month);t?(m=t.amount,h=u.indexOf(t)):m=0}else m=0;-1===h&&u.length>0&&(h=0,m=u[0].amount);const f={};appData.exchangeRate.forEach(t=>{f[t.pair]=t.currentRate});const g=[];for(let o=0;o<a;o++){let a=-1,s=0;if(u.length>0){const t=u.find(t=>0===t.month);t?(s=t.amount,a=u.indexOf(t)):s=0}else s=0;-1===a&&u.length>0&&(a=0,s=u[0].amount);let i=t.cash;const l=e.map(t=>({...t,Kuchisu:t.Kuchisu,CurrentValuePerUnit:t.CurrentValuePerUnit,AveragePrice:t.AveragePrice}));let h=f,m=!1,p=-1;const x=[];for(let t=0;t<n;t++){const n=`${Math.floor(t/12)}\u5e74${t%12+1}\u6708`,o=0===t?e.reduce((t,e)=>t+e.Kuchisu/e.Tani*e.CurrentValuePerUnit,0):x[t-1].endOfPeriodAssets,f=calculateTaxRate(t,appData.tax);let g=!1;if(a+1<u.length){const e=u[a+1];t===e.month&&(s=e.amount,a++,g=!0)}t>0&&t%12==0&&!g&&(s*=1+d);const b=s,{gain:y,gain_tax:w}=ProcessDividendDistribution(t,l,f,appData);i+=y;let{currentCash:M,monthlyIncome:C,totalExpense:E,requiredAssetSale:k}=handleIncomeAndExpense(t,i,appData,b);i=M;let $=k;const A=handleTuikaInvestment(t,i,l,appData,r);i=A.currentCash,l.forEach((e,n)=>{e.Meigara.endsWith("\uff1c\u65e7NISA\uff1e")&&12*e.TaxStartYear+e.TaxStartMonth-1===t&&e.AveragePrice<e.CurrentValuePerUnit&&(e.AveragePrice=e.CurrentValuePerUnit)});let S=0;if($>0){const e=handleAssetSale($,i,l,f,t);i=e.currentCash,S=e.taxPayment,m=e.fireFailure,m&&-1===p&&(p=t)}const P=applyMonthlyReturn(t,l,c,f,h);let I=P.endOfPeriodAssets;const R=P.stockDetails;h=P.nextExchangeRates;const v=I+i;v<0&&(m=!0,-1===p&&(p=t)),!0===m&&(I=0,i=0,R.forEach(t=>{t.kuchisu=0})),x.push({yearMonth:n,transferAssets:o,expense:E,income:C+y,Gain:y,tax:S+w,Gain_tax:w,cash:i,tuika:A.monthlyTuikaInvestment,endOfPeriodAssets:I,totalAsset:v,stockDetails:R,fxRates:h,isFailure:m})}g.push({trialId:o+1,success:!m,failureMonth:m?p:n,history:x})}return g}let totalAssetChartInstance=null;function initializeDatas(){const t=JSON.parse(localStorage.getItem("fireSimulatorData"))||{};let e=[];for(let n of t.tuika)"\uff11\u56de"===n.pattern?n.toMonth_totalMonths=n.month:n.toMonth_totalMonths=compareMonthAndGetCurrent(n.toMonth),e.push(n);t.tuika=e,localStorage.setItem("fireSimulatorData",JSON.stringify(t))}function showHideStocksInfo(t,e){if(-1===t){let t=document.querySelectorAll(".meigara-header-group");return t.forEach(t=>{t.classList.add("collapsed-detail-text")}),t=document.querySelectorAll(".hanrei_button"),void t.forEach(t=>{t.classList.remove("showed-detail-button")})}e.classList.toggle("showed-detail-button");const n=document.querySelectorAll("#detail-table tr");n[0].querySelectorAll("td, th")[t+2].classList.toggle("collapsed-detail-text");const a=11+4*t;n.forEach(t=>{for(let e=0;e<4;e++){let n=a+e;if("header-row-1"===t.id)continue;"header-row-2"===t.id&&n--;const o=t.querySelector(`:nth-child(${n})`);o&&o.classList.toggle("collapsed-detail-text")}})}function drawFinalAssetsDistributionChart(t){const e=document.getElementById("PercentageByFinalAssets");if(!e)return;e.style.maxHeight="500px",e.style.overflowY="auto",e.innerHTML="<h2>\u6700\u7d42\u8cc7\u7523\u5206\u5e03</h2>";const n=document.createElement("canvas");n.id="finalAssetsPieChart",n.style.width="400px",n.style.height="400px",n.style.maxWidth="95%",n.style.maxHeight="400px",n.style.margin="20px auto",n.style.display="block",e.appendChild(n);const a=t.map(t=>{const e=t.history[t.history.length-1];return e?e.endOfPeriodAssets:0}),o=[{label:"0\u5186",min:-1/0,max:1},{label:"1\u5186\uff5e500\u4e07\u5186\u672a\u6e80",min:1,max:5e6},{label:"500\u4e07\u5186\uff5e1000\u4e07\u5186\u672a\u6e80",min:5e6,max:1e7},{label:"1000\u4e07\u5186\uff5e2000\u4e07\u5186\u672a\u6e80",min:1e7,max:2e7},{label:"2000\u4e07\u5186\uff5e3000\u4e07\u5186\u672a\u6e80",min:2e7,max:3e7},{label:"3000\u4e07\u5186\uff5e4000\u4e07\u5186\u672a\u6e80",min:3e7,max:4e7},{label:"4000\u4e07\u5186\uff5e5000\u4e07\u5186\u672a\u6e80",min:4e7,max:5e7},{label:"5000\u4e07\u5186\uff5e7000\u4e07\u5186\u672a\u6e80",min:5e7,max:7e7},{label:"7000\u4e07\u5186\uff5e1\u5104\u5186\u672a\u6e80",min:7e7,max:1e8},{label:"1\u5104\u5186\uff5e1.5\u5104\u5186\u672a\u6e80",min:1e8,max:15e7},{label:"1.5\u5104\u5186\uff5e2\u5104\u5186\u672a\u6e80",min:15e7,max:2e8},{label:"2\u5104\u5186\uff5e5\u5104\u5186\u672a\u6e80",min:2e8,max:5e8},{label:"5\u5104\u5186\uff5e10\u5104\u5186\u672a\u6e80",min:5e8,max:1e9},{label:"10\u5104\u5186\u4ee5\u4e0a",min:1e9,max:1/0}],r=new Array(o.length).fill(0);a.forEach(t=>{for(let e=0;e<o.length;e++){const{min:n,max:a}=o[e];if(e===o.length-1){if(t>=n){r[e]++;break}}else if(t>=n&&t<a){r[e]++;break}}});const s=o.map(t=>t.label),i=t.length,l=["rgba(231, 76, 60, 0.8)","rgba(52, 152, 219, 0.8)","rgba(46, 204, 113, 0.8)","rgba(241, 196, 15, 0.8)","rgba(155, 89, 182, 0.8)","rgba(230, 126, 34, 0.8)","rgba(22, 160, 133, 0.8)","rgba(52, 73, 94, 0.8)","rgba(149, 165, 166, 0.8)","rgba(192, 57, 43, 0.8)","rgba(108, 52, 151, 0.8)","rgba(39, 174, 96, 0.8)","rgba(243, 156, 18, 0.8)","rgba(127, 140, 141, 0.8)"].slice(0,o.length);new Chart(n,{type:"pie",data:{labels:s,datasets:[{label:"\u6700\u7d42\u8cc7\u7523\u984d\u5225\u306e\u5272\u5408",data:r,backgroundColor:l,borderColor:"rgba(255, 255, 255, 1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:10,bottom:10,left:10,right:10}},plugins:{legend:{display:!0,position:"right",labels:{font:{size:12}}},tooltip:{callbacks:{label:function(t){let e=t.label||"";const n=t.raw;return e+=`: ${n} \u56de (${(n/i*100).toFixed(1)}%)`,e}}}}}})}function randn(){let t=0,e=0;for(;0===t;)t=Math.random();for(;0===e;)e=Math.random();return Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*e)}function calculateNextOUPRate(t,e,n,a,o,r){if(t<=0||n<=0)return t;const s=Math.log(t),i=s+e*(Math.log(n)-s)*o+a*r;return Math.exp(i)}function calculateNextExchangeRates(t,e,n,a=1/12){const o=["USD/JPY","EUR/JPY","EUR/USD"],r=o.length,s={};t.forEach(t=>{s[t.pair]={S_t:n[t.pair],theta:t.reversionSpeed,mu:t.targetRate,sigma:t.volatility/100}});const i=numeric.rep(r,r,0);for(let t=0;t<r;t++)i[t][t]=1;let l;e.forEach(t=>{const e=o.indexOf(t.pairA),n=o.indexOf(t.pairB);-1!==e&&-1!==n&&(i[e][n]=t.keisu,i[n][e]=t.keisu)});try{l=numeric.cholesky(i)}catch(t){l=numeric.identity(r)}const c=numeric.rep(r,1);for(let t=0;t<r;t++)c[t][0]=randn();const d=numeric.dot(l,c),u={},h=Math.sqrt(a);return o.forEach((t,e)=>{const o=s[t],r=d[e][0]*h;o&&void 0!==o.S_t&&null!==o.S_t?u[t]=calculateNextOUPRate(o.S_t,o.theta,o.mu,o.sigma,a,r):u[t]=n[t]||1}),u}document.addEventListener("DOMContentLoaded",()=>{initializeDatas();const t=document.getElementById("simulation-buttons"),e=document.getElementById("summary-text"),n=document.getElementById("simulation-detail"),a=document.getElementById("detail-title"),o=document.getElementById("detail-table-body"),r=document.getElementById("failure-filter"),s=document.getElementById("meigara-legend"),i=document.getElementById("header-row-1"),l=document.getElementById("header-row-2"),c=document.getElementById("chart-container");document.getElementById("totalAssetChart");let d=[],u=-1,h=[];function m(r){t.innerHTML="",c.style.display="none",d.forEach((e,s)=>{if(r&&e.success)return;const i=document.createElement("button");i.id=`result-${e.trialId}`,i.className="simulation-button "+(e.success?"success":"failure"),i.textContent=e.trialId,i.addEventListener("click",()=>{showHideStocksInfo(-1,null),function(e,r){u=e;const s=d[e],i=s.history;a.textContent=`\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u8a73\u7d30\uff08\u8a66\u884c #${s.trialId} - ${s.success?"\u6210\u529f":"\u5931\u6557"}\uff09`,o.innerHTML="",i.forEach((t,e)=>{const n=o.insertRow();let a=`<td class="text-left">${t.yearMonth}</td>`,r=t.transferAssets;a+=`<td>${window.formatNumber(r)}</td>`,a+=`<td>${window.formatNumber(t.expense)}</td>`,a+=`<td>${window.formatNumber(t.income)}<br>\u5185\u914d\u5f53(${window.formatNumber(t.Gain)})</td>`,a+=`<td>${window.formatNumber(t.tax)}<br>\u5185\u914d\u5f53\u7a0e(${window.formatNumber(t.Gain_tax)})</td>`,a+=`<td>${window.formatNumber(t.cash)}</td>`,a+=`<td>${window.formatNumber(t.tuika)}</td>`;const s=t.endOfPeriodAssets-(t.transferAssets+t.tuika),l=`${window.formatNumber(t.endOfPeriodAssets)}<br>(${window.formatNumber(s)})`;a+=`<td>${l}</td>`,a+=`<td>${window.formatNumber(t.totalAsset)}</td>`;let c="";for(let e in t.fxRates)""!=c?c+="<BR>"+e+":"+t.fxRates[e].toFixed(2):c=e+":"+t.fxRates[e].toFixed(2);a+=`<td>${c}</td>`,t.stockDetails.forEach((t,n)=>{const o=window.appData.stocks[n],r=0===e?o.Kuchisu:i[e-1].stockDetails[n].kuchisu,s=t.kuchisu-r,l=s>0?`<span class="kuchisu-increase">(+${window.formatNumber(s)})</span>`:`(${window.formatNumber(s)})`,c=`${window.formatNumber(t.kuchisu)}<br>${l}`,d=t.currentValuePerUnit,u=t.averagePrice,h=`${window.formatNumber(d)}/${window.formatNumber(u)}<br>${t.taxPerUnit>1e-7?`(${t.taxPerUnit.toFixed(4)}\u5186/\u53e3)`:"\u7121\u7a0e"}`;a+=`\n                            <td class='collapsed-detail-text'>${t.rate.toFixed(2)}%<br>(${t.monteCarlo.toFixed(2)}%/${t.fxrate.toFixed(2)}%)</td>\n                            <td class='collapsed-detail-text'>${window.formatNumber(t.value)}</td>\n                            <td class='collapsed-detail-text'>${c}</td>\n                            <td class='collapsed-detail-text'>${h}</td>\n                        `}),n.innerHTML=a,o.appendChild(n)}),n.style.display="block";const l=i.map(t=>t.yearMonth),h=i.map(t=>t.totalAsset),m=document.getElementById("totalAssetChart").getContext("2d");if(totalAssetChartInstance&&totalAssetChartInstance.destroy(),totalAssetChartInstance=new Chart(m,{type:"line",data:{labels:l,datasets:[{label:"(9) \u7dcf\u8cc7\u7523\u306e\u63a8\u79fb (\u7dda\u5f62)",data:h,yAxisID:"y",borderColor:s.success?"#3498db":"#e74c3c",backgroundColor:s.success?"rgba(52, 152, 219, 0.1)":"rgba(231, 76, 60, 0.1)",borderWidth:2,tension:.1,pointHitRadius:10,pointRadius:2,pointHoverRadius:6,fill:!1},{label:"(9) \u7dcf\u8cc7\u7523\u306e\u63a8\u79fb (\u5bfe\u6570)",data:h,yAxisID:"y2",borderColor:"rgba(155, 89, 182, 1)",backgroundColor:"rgba(155, 89, 182, 0.1)",borderWidth:2,tension:.1,fill:!1,pointHitRadius:10,pointRadius:2,pointHoverRadius:6,hidden:!1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:`\u8a66\u884c #${s.trialId} \u306e\u7dcf\u8cc7\u7523\u306e\u63a8\u79fb (${s.success?"\u6210\u529f":"\u5931\u6557"})`},legend:{display:!1}},scales:{x:{title:{display:!0,text:"\u671f\u9593"},ticks:{autoSkip:!0,maxTicksLimit:20}},y:{title:{display:!0,text:"\u7dcf\u8cc7\u7523\u984d (\u7dda\u5f62)"},beginAtZero:!1,ticks:{callback:function(t){return window.formatNumber(t)}}},y2:{type:"logarithmic",position:"right",title:{display:!0,text:"\u7dcf\u8cc7\u7523\u984d (\u5bfe\u6570)"},grid:{drawOnChartArea:!1},ticks:{callback:function(t){return window.formatNumber(t)}}}}}}),r){const e=r.getBoundingClientRect();t.getBoundingClientRect();let n=window.scrollY+e.bottom,a=window.scrollX;const o=372;n+o>window.scrollY+window.innerHeight&&(n=window.scrollY+e.top-o,n<window.scrollY&&(n=window.scrollY+50));const s=622;a+s>window.scrollX+window.innerWidth&&(a=window.scrollX+window.innerWidth-s-10),a<window.scrollX&&(a=window.scrollX+10),c.style.top=`${Math.max(0,n)}px`,c.style.left=`${Math.max(0,a)}px`,c.style.display="block"}else c.style.display="none"}(s,i)}),t.appendChild(i)}),drawFinalAssetsDistributionChart(d);const s=d.filter(t=>t.success).length,i=d.length-s,l=(d.length>0?s/d.length*100:0).toFixed(1),h=d.filter(t=>t.success).map(t=>t.history[t.history.length-1].totalAsset);let m=0,g=0;h.length>0&&(m=f(h,50),g=f(h,10));const p=d.filter(t=>!t.success).map(t=>t.history[t.history.length-1].totalAsset),x=d.filter(t=>!t.success).map(t=>t.failureMonth+1);let b=0,y=0;p.length>0&&(b=f(p,50),y=f(x,50));const w=function(t,e){let n="";t>=99?(stars="\u2b50\u2b50\u2b50\u2b50\u2b50\u2b50\u2b50\u2b50\u2b50\u2b50",comment=`\u3010\u8a55\u4fa1\uff1aFIRE\u3057\u306a\u3044\u30ea\u30b9\u30af\u3092\u691c\u8a0e\u3057\u307e\u3057\u3087\u3046\ud83d\ude0a\u3011\u6210\u529f\u7387 ${t.toFixed(1)} \u3067\u3059\u3002\ud83d\ude0a\u3082\u306f\u3084\u3001FIRE\u305b\u305a\u306b\u4ed5\u4e8b\u3092\u7d9a\u3051\u308b\u3053\u3068\u306e\u30ea\u30b9\u30af\u3092\u691c\u8a0e\u3059\u308b\u6bb5\u968e\u3067\u3059\u3002<br>\u597d\u304d\u306a\u3053\u3068\u3092\u4ed5\u4e8b\u306b\u3057\u3066\u3044\u308b\u306a\u3089\u7d9a\u3051\u307e\u3057\u3087\u3046\u3002<br>\u3067\u3059\u304c\u3001\u6211\u6162\u3092\u3057\u3066\u3044\u308b\u4ed5\u4e8b\u306a\u3089\u3070\uff11\u5ea6\u3057\u304b\u306a\u3044\u4eba\u751f\u3060\u3068\u3044\u3046\u3053\u3068\u3082\u7406\u89e3\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002<br>\u8cc7\u7523\u8a08\u753b\u306f\u6975\u3081\u3066\u512a\u79c0\u3067\u3059\u3002\u3010FIRE\u5f8c\u3001\u4f55\u3092\u3059\u308b\u304b\uff1f\u3011\u306b\u6ce8\u529b\u3057\u307e\u3057\u3087\u3046\u3002<br>\u5065\u5eb7\u5bff\u547d\u306f\u601d\u3063\u3066\u3044\u308b\u4ee5\u4e0a\u306b\u77ed\u3044\u3067\u3059\u3088\u3002`):t>=95?(stars="\u2b50\u2b50\u2b50\u2b50\u2b50\u2b50\u2b50\u2b50\u2b50\u2606",comment=`\u3010\u8a55\u4fa1\uff1a\u6975\u3081\u3066\u9ad8\u3044\u78ba\u5b9f\u6027\u3011\u6210\u529f\u7387 ${t.toFixed(1)} \u3067\u3001\u3042\u306a\u305f\u306eFIRE\u8a08\u753b\u306f\u6975\u3081\u3066\u9ad8\u3044\u78ba\u5b9f\u6027\u3092\u6301\u3063\u3066\u3044\u307e\u3059\u3002<br>\u8cc7\u7523\u304c\u67af\u6e07\u3059\u308b\u78ba\u7387\u306f\u975e\u5e38\u306b\u4f4e\u3044\u3067\u3059\u304c\u3001\u3055\u3089\u306a\u308b\u7279\u7570\u306a\u51fa\u8cbb\u3084\u3001\u4e00\u6642\u7684\u306a\u81ea\u56fd\u901a\u8ca8\u5b89\u3001\u307e\u305f\u306f\u8907\u6570\u306e\u5371\u6a5f\u304c\u91cd\u306a\u308b\u300c\u30d1\u30fc\u30d5\u30a7\u30af\u30c8\u30b9\u30c8\u30fc\u30e0\u300d\u306e\u3088\u3046\u306a\u4e8b\u614b\u304c\u9023\u7d9a\u3059\u308c\u3070\u3001\u6700\u60aa\u306e\u30b7\u30ca\u30ea\u30aa\u3067\u306f\u67af\u6e07\u3059\u308b\u53ef\u80fd\u6027\u3082\u6b8b\u308a\u307e\u3059\u3002<br>\u8a08\u753b\u306f\u512a\u79c0\u3067\u3059\u304c\u3001\u307e\u3060\u3001\u7a74\u304c\u3042\u308b\u3088\u3046\u3067\u3059\u3002\u50b5\u5238\u306a\u3069\u306e\u7d44\u307f\u5408\u308f\u305b\u3082\u691c\u8a0e\u3059\u308c\u3070\u3001\u3088\u308a\u78ba\u5b9f\u306aFIRE\u304c\u3067\u304d\u308b\u304b\u3082\u3057\u308c\u307e\u305b\u3093\u3002<br>\u3042\u308f\u305b\u3066\u3001FIRE\u5f8c\u306b\u3059\u308b\u3053\u3068\u3092\u3001\u305d\u308d\u305d\u308d\u59cb\u3081\u3066\u3082\u826f\u3044\u3053\u308d\u3067\u306f\uff1f`):t>=90?(stars="\u2b50\u2b50\u2b50\u2b50\u2b50\u2b50\u2b50\u2606\u2606\u2606",comment=`\u3010\u8a55\u4fa1\uff1a\u9ad8\u3044\u78ba\u5b9f\u6027\u3060\u304c\u30ea\u30b9\u30af\u3042\u308a\u3011\u6210\u529f\u7387 ${t.toFixed(1)} \u306f\u3001\u6bd4\u8f03\u7684\u9ad8\u3044\u78ba\u5b9f\u6027\u3067\u3059\u3002<br>${(100-t).toFixed(1)}%\u306e\u78ba\u7387\u3067\u8cc7\u7523\u304c\u5c3d\u304d\u308b\u672a\u6765\u304c\u793a\u3055\u308c\u3066\u3044\u307e\u3059\u3002<br>\u4e88\u671f\u305b\u306c\u5927\u304d\u306a\u51fa\u8cbb\u3084\u3001\u5e02\u5834\u304c\u9577\u671f\u9593\u505c\u6ede\u3059\u308b\u300c\u30d1\u30fc\u30d5\u30a7\u30af\u30c8\u30b9\u30c8\u30fc\u30e0\u300d\u306e\u3088\u3046\u306a\u4e8b\u614b\u304c\u91cd\u306a\u3063\u305f\u5834\u5408\u3001\u8cc7\u7523\u306f\u67af\u6e07\u3057\u307e\u3059\u3002<br>\u3053\u306e\u30ea\u30b9\u30af\u3092\u771f\u5263\u306b\u53d7\u3051\u6b62\u3081\u3001\u4e07\u304c\u4e00\u306e\u5834\u5408\u306e\u53ce\u5165\u6e90\u3092\u78ba\u4fdd\u3059\u308b\u306a\u3069\u3001\u3088\u308a\u53b3\u3057\u3044\u691c\u8a0e\u304c\u5fc5\u8981\u3067\u3059\u3002<br>FIRE\u306f\u3082\u3046\u898b\u3048\u3066\u3044\u307e\u3059\u3002FIRE\u5f8c\u306b\u3059\u308b\u3053\u3068\u3082\u304d\u3061\u3093\u3068\u8a08\u753b\u3057\u3066\u304a\u304d\u307e\u3057\u3087\u3046\u3002\u81a8\u5927\u306a\u6642\u9593\u3092\u6709\u610f\u7fa9\u306b\u6d88\u8cbb\u3059\u308b\u305f\u3081\u306b\u3002`):t>=80?(stars="\u2b50\u2b50\u2b50\u2b50\u2b50\u2606\u2606\u2606\u2606\u2606",comment=`\u3010\u8a55\u4fa1\uff1a\u5371\u967a\u6c34\u57df\u30fb\u5341\u5206\u306a\u691c\u8a0e\u304c\u5fc5\u8981\u3011\u6210\u529f\u7387 ${t.toFixed(1)} \u306f\u3001FIRE\u306e\u78ba\u5b9f\u6027\u3068\u3057\u3066\u306f\u4e0d\u5341\u5206\u3067\u3059\u3002<br>\u6210\u529f\u3068\u5931\u6557\u304c\u7d0420%\u306e\u5dee\u3067\u767a\u751f\u3057\u3066\u304a\u308a\u3001\u8cc7\u7523\u304c\u67af\u6e07\u3059\u308b\u53ef\u80fd\u6027\u306f\u7121\u8996\u3067\u304d\u307e\u305b\u3093\u3002<br>\u7279\u7570\u306a\u51fa\u8cbb\u3084\u3001\u4e00\u6642\u7684\u306a\u81ea\u56fd\u901a\u8ca8\u5b89\u3001\u307e\u305f\u306f\u30a4\u30f3\u30d5\u30ec\u306e\u4e88\u60f3\u4ee5\u4e0a\u306e\u9032\u884c\u304c\u91cd\u306a\u308b\u6700\u60aa\u306e\u30b1\u30fc\u30b9\u3067\u306f\u3001\u8a08\u753b\u306f\u5bb9\u6613\u306b\u7834\u7dbb\u3057\u307e\u3059\u3002<br>\u8a08\u753b\u3092\u5b9f\u884c\u306b\u79fb\u3059\u524d\u306b\u3001\u8cc7\u7523\u306e\u5897\u5f37\u3084\u751f\u6d3b\u8cbb\u306e\u898b\u76f4\u3057\u3092\u5f37\u304f\u63a8\u5968\u3057\u307e\u3059\u3002<br>FIRE\u3067\u306f\u306a\u304f\u3001\u72ec\u7acb\u3057\u305f\u3044\uff01\u3068\u3044\u3046\u306e\u3067\u3042\u308c\u3070\u3001\u751f\u6d3b\u3078\u306e\u4fdd\u967a\u3092\u639b\u3051\u305f\u72b6\u614b\u3067\u52dd\u8ca0\u306b\u51fa\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u6c34\u6e96\u3067\u3059\u3002\u3082\u3061\u308d\u3093\u904b\u8ee2\u8cc7\u91d1\u3068\u3057\u3066\u3053\u306e\u8cc7\u7523\u306b\u624b\u3092\u4ed8\u3051\u3061\u3083\u3060\u3081\u3067\u3059\u3088\ud83d\udca6`):t>=50?(stars="\u2b50\u2b50\u2b50\u2606\u2606\u2606\u2606\u2606\u2606\u2606",comment=`\u3010\u8a55\u4fa1\uff1a\u6975\u3081\u3066\u5371\u967a\u3011\u6210\u529f\u7387 ${t.toFixed(1)} \u306f\u3001\u5931\u6557\u3059\u308b\u78ba\u7387\u304c\u6210\u529f\u3059\u308b\u78ba\u7387\u3068\u307b\u3068\u3093\u3069\u5909\u308f\u308a\u307e\u305b\u3093\u3002<br>\u3053\u306e\u72b6\u614b\u3067FIRE\u3092\u601d\u8003\u3059\u308b\u306e\u306f\u6975\u3081\u3066\u5371\u967a\u3067\u3059\u3002\u307b\u3093\u306e\u5c11\u3057\u306e\u4e8b\u614b\u3067\u3001\u3042\u3063\u3068\u3044\u3046\u9593\u306b\u8cc7\u7523\u306f\u67af\u6e07\u3057\u307e\u3059\u3002<br>\u73fe\u72b6\u306e\u30c7\u30fc\u30bf\u3067\u306f\u6b63\u793e\u54e1\u3092\u8f9e\u3081\u308b\u3079\u304d\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\u9069\u5ea6\u306b\u30a2\u30eb\u30d0\u30a4\u30c8\u3059\u308c\u3070\u2026\u306f\u3001\u73fe\u5b9f\u9003\u907f\u3067\u3059\u3002\u7d4c\u6e08\u7684\u72ec\u7acb\u306f\u6210\u7acb\u3057\u3066\u3044\u307e\u305b\u3093\u3002<br>\u7d20\u76f4\u306b\u4f1a\u793e\u54e1\u3092\u7d9a\u3051\u307e\u3057\u3087\u3046\u3002`):t>=40?(stars="\u2b50\u2b50\u2606\u2606\u2606\u2606\u2606\u2606\u2606\u2606",comment=`\u3010\u8a55\u4fa1\uff1a\u30c0\u30e1\u7d76\u5bfe\u3011\u6210\u529f\u7387 ${t.toFixed(1)} \u306f\u3001\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u5927\u534a\u3067\u8cc7\u7523\u304c\u67af\u6e07\u3059\u308b\u3068\u3044\u3046\u7d50\u679c\u306b\u306a\u308a\u307e\u3057\u305f\u3002<br>\u3053\u306e\u72b6\u614b\u3067\u306fFIRE\u306eF\u306e\u5b57\u3059\u3089\u8a9e\u308b\u6bb5\u968e\u3067\u306f\u3001\u307e\u3060\u3042\u308a\u307e\u305b\u3093\u3002`):t>=20?(stars="\u2b50\u2606\u2606\u2606\u2606\u2606\u2606\u2606\u2606\u2606",comment=`\u3010\u8a55\u4fa1\uff1a\u3048\uff1f\u3011\u6210\u529f\u7387 ${t.toFixed(1)}\u3067\u3057\u305f\u3002<br>\u5b9a\u7387\u3067\u53f3\u80a9\u4e0a\u304c\u308a\u306b\u5229\u76ca\u304c\u51fa\u308b\u975e\u73fe\u5b9f\u7684\u306a\u30b7\u30df\u30e5\u30ec\u30fc\u30bf\u30fc\u3067\u6e80\u8db3\u3057\u3066\u304a\u304f\u3079\u304d\u6bb5\u968e\u3067\u3059\u3002`):(stars="\u2606\u2606\u2606\u2606\u2606\u2606\u2606\u2606\u2606\u2606",comment=`\u6210\u529f\u7387 ${t.toFixed(1)} \u3067\u3059\u3002`);n=momonga?stars+"<BR>"+comment:stars+"<BR><BR>"+comment;t>=50&&e<=0&&(n+="<br>\u2192 **\u3010\u6ce8\u610f\u3011** \u6210\u529f\u30b1\u30fc\u30b9\u3067\u3042\u3063\u3066\u3082\u3001\u904b\u304c\u60aa\u3044\u3068\u8cc7\u7523\u304c\u307b\u3068\u3093\u3069\u6b8b\u3089\u306a\u3044\uff08\u307e\u305f\u306f\u30de\u30a4\u30ca\u30b9\u306b\u306a\u308b\uff09\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002");return n}(parseFloat(l),g);e.innerHTML=`\n\t\t\t    <h2>\u5168\u4f53\u8a55\u4fa1</h2>\n\t\t\t    <p style="font-size: 1.2em; font-weight: bold; color: #2980b9;">\n\t\t\t        ${w}\n\t\t\t    </p>\n\t\t\t    <hr style="margin: 15px 0;">\n\n\t\t\t    **\u8a66\u884c\u56de\u6570:** ${d.length}\u56de<br>\n\t\t\t    **FIRE\u6210\u529f\u7387:** <span style="color:#3498db; font-size: 1.1em; font-weight: bold;">${l}%</span> (${s}\u56de)<br>\n\t\t\t    **FIRE\u5931\u6557\u7387:** <span style="color:#e74c3c; font-size: 1.1em; font-weight: bold;">${(100-l).toFixed(1)}%</span> (${i}\u56de)\n\t\t\t    <hr style="margin: 10px 0;">\n\n\t\t\t    <div style="display: flex; justify-content: space-around; text-align: left; padding: 10px;">\n\t\t\t        <div style="padding-right: 15px; flex: 1;">\n\t\t            <h3>\u2705 \u6210\u529f\u30b1\u30fc\u30b9 (\u6700\u7d42\u7dcf\u8cc7\u7523\u4e88\u6e2c)</h3>\n\t\t            <p>\n\t\t                <span style="font-weight: bold;">\u4e2d\u592e\u5024 (50%\u30bf\u30a4\u30eb):</span> ${window.formatNumber(Math.round(m))} \u5186<br>\n\t\t                <span style="font-weight: bold; color: #e67e22;">\u60b2\u89b3\u7684\u306a\u30b1\u30fc\u30b9 (10%\u30bf\u30a4\u30eb):</span> ${window.formatNumber(Math.round(g))} \u5186\n\t\t            </p>\n\t\t            <span style="font-size: 0.9em; display: block;">\u203b 90%\u306e\u78ba\u7387\u3067\u300110%\u30bf\u30a4\u30eb\u4ee5\u4e0a\u306e\u8cc7\u7523\u304c\u6b8b\u308a\u307e\u3059\u3002</span>\n\t\t\t        </div>\n        \n\t\t\t        <div style="border-left: 1px solid #ccc; padding-left: 15px; flex: 1;">\n\t\t\t            <h3>\u274c \u5931\u6557\u30b1\u30fc\u30b9 (\u30ea\u30b9\u30af\u5206\u6790)</h3>\n\t\t\t            <p>\n\t\t\t                <span style="font-weight: bold;">\u5931\u6557\u307e\u3067\u306e\u671f\u9593 (\u4e2d\u592e\u5024):</span> ${(t=>{const e=Math.round(t);if(e<=0)return"\u958b\u59cb\u6642";const n=Math.floor(e/12),a=e%12;return n>0?`${n}\u5e74${a}\u30f6\u6708`:`${a}\u30f6\u6708`})(y)}<br>\n\t\t\t                <span style="font-weight: bold; color: #c0392b;">\u7d42\u4e86\u6642\u8cc7\u7523 (\u4e2d\u592e\u5024):</span> ${window.formatNumber(Math.round(b))} \u5186\n\t\t\t            </p>\n\t\t\t            <span style="font-size: 0.9em; display: block;">\u203b \u5931\u6557\u30ea\u30b9\u30af\u304c\u767a\u751f\u3057\u305f\u5834\u5408\u3001\u3053\u306e\u671f\u9593\u3067\u8cc7\u7523\u304c\u67af\u6e07\u3059\u308b\u53ef\u80fd\u6027\u304c\u9ad8\u3044\u3067\u3059\u3002</span>\n\t\t\t        </div>\n\t\t\t    </div>\n\t\t\t`}function f(t,e){if(0===t.length)return 0;const n=[...t].sort((t,e)=>t-e),a=e/100*(n.length-1);if(a%1==0)return n[a];{const t=Math.floor(a),e=Math.ceil(a),o=a-t;return n[t]*(1-o)+n[e]*o}}c.addEventListener("dblclick",()=>{c.style.display="none",totalAssetChartInstance&&(totalAssetChartInstance.destroy(),totalAssetChartInstance=null)});const g=localStorage.getItem("fireSimulatorData");if(g)try{const appData=JSON.parse(g);if(window.appData=appData,!appData.stocks||0===appData.stocks.length)return void(e.textContent="\u30a8\u30e9\u30fc: \u4fdd\u6709\u9298\u67c4\u304c\u767b\u9332\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\u3067\u304d\u307e\u305b\u3093\u3002");!function(t){let e=i.lastElementChild;for(;e&&"header-row-1-month"!==e.id&&i.children.length>1;)i.removeChild(i.lastElementChild),e=i.lastElementChild;for(;l.children.length>9;)l.removeChild(l.lastChild);h=t.map(t=>t.Meigara),t.forEach((t,e)=>{const n=document.createElement("th");n.colSpan="4",n.textContent=`\u9298\u67c4${String.fromCharCode(65+e)}`,n.classList.add("meigara-header-group"),n.classList.add("collapsed-detail-text"),n.dataset.meigaraIndex=e,i.appendChild(n);const a=document.createElement("th");a.innerHTML="\u5229\u7387\uff05<br>\u91d1\u878d\u5546\u54c1/\u70ba\u66ff",a.classList.add("meigara-header-group"),a.classList.add("collapsed-detail-text"),l.appendChild(a);const o=document.createElement("th");o.textContent="\u8cc7\u7523\u984d",o.classList.add("meigara-header-group"),o.classList.add("collapsed-detail-text"),l.appendChild(o);const r=document.createElement("th");r.textContent="\u4fdd\u6709\u53e3\u6570",r.classList.add("meigara-header-group"),r.classList.add("collapsed-detail-text"),l.appendChild(r);const s=document.createElement("th");s.innerHTML="\u73fe\u5728/<br>\u5e73\u5747<br>(\u7a0e\u984d/1\u53e3)",s.classList.add("meigara-header-group"),s.classList.add("collapsed-detail-text"),l.appendChild(s)});const n=document.createElement("th");n.colSpan="9",n.textContent="\u6708\u6b21\u53ce\u652f\u30fb\u8cc7\u7523\u7dcf\u984d",i.insertBefore(n,i.children[1]),s.innerHTML="<h3>\u51e1\u4f8b</h3>"+t.map((t,e)=>`<button class="hanrei_button" onclick="showHideStocksInfo(${e},this)">\u9298\u67c4${String.fromCharCode(65+e)}: ${t.Meigara}</button>`).join("<br><br>")+"<BR><BR>\u203b\u3000\u51e1\u4f8b\u306e\u300c\u9298\u67c4A\u3001\u9298\u67c4B\u30fb\u30fb\u30fb\u300d\u3092\u30af\u30ea\u30c3\u30af\u3059\u308b\u3068\u3001\u5404\u9298\u67c4\u306e\u63a8\u79fb\u306e\u8868\u793a\u30fb\u975e\u8868\u793a\u3092\u5207\u308a\u66ff\u3048\u3089\u308c\u307e\u3059\u3002<br>"}(appData.stocks),d=runMonteCarloSimulation(appData),m(!1),r.addEventListener("change",t=>{m(t.target.checked)})}catch(t){e.textContent=`\u30c7\u30fc\u30bf\u306e\u8aad\u307f\u8fbc\u307f\u307e\u305f\u306f\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u5b9f\u884c\u4e2d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f: ${t.message}`}else e.textContent="\u30a8\u30e9\u30fc: \u8a2d\u5b9a\u30c7\u30fc\u30bf\u304cLocalStorage\u306b\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3002\u8a2d\u5b9a\u30da\u30fc\u30b8\u3067\u30c7\u30fc\u30bf\u3092\u4fdd\u5b58\u3057\u3066\u304f\u3060\u3055\u3044\u3002"});