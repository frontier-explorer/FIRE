<!DOCTYPE html><html lang="ja"><meta charset="UTF-8"><meta name="viewport"content="width=device-width,initial-scale=1"><title>ä¿æœ‰è¨¼åˆ¸</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KVH65NMPDK"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-KVH65NMPDK")</script><link rel="stylesheet"href="style.css"><style>.instruction-box{background-color:#f0f8ff;border-left:5px solid #3498db;padding:15px;margin-bottom:20px;border-radius:4px}.stock-item input:disabled,.stock-item select:disabled{background-color:#e9ecef;cursor:not-allowed}.meigara-group{display:flex;gap:10px;align-items:flex-end}.meigara-group>div{flex:1}.meigara-group label{width:auto;margin-right:0}.custom-account-type-group{margin-top:5px}.custom-account-type-group input{width:100%}</style><div class="container"><header><h1>ä¿æœ‰è¨¼åˆ¸</h1><p>ä¿æœ‰ã™ã‚‹é‡‘èè³‡ç”£ã®åŸºæœ¬æƒ…å ±ã‚’å…¥åŠ›ã—ã¾ã™ã€‚</header><main><div class="input-section"><h2>ä¿æœ‰éŠ˜æŸ„ä¸€è¦§</h2><div class="instruction-box"><p>ğŸ’¡ <strong>ãƒªã‚¿ãƒ¼ãƒ³ã¨ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ã®æ³¨æ„ç‚¹</strong><ul><li>**ãƒ™ãƒ¼ã‚¹éŠ˜æŸ„å**ã¨**å£åº§ç¨®åˆ¥**ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€**éŠ˜æŸ„åï¼œå£åº§ç¨®åˆ¥ï¼**ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãŒè‡ªå‹•ã§ç”Ÿæˆã•ã‚Œã¾ã™ã€‚<li>**å£åº§ç¨®åˆ¥ã§ã€Œè‡ªç”±å…¥åŠ›ã€ã‚’é¸æŠã—ãŸå ´åˆã€ãã®ä¸‹ã«è¡¨ç¤ºã•ã‚Œã‚‹å…¥åŠ›æ¬„ã«ä»»æ„ã®åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚**<li>**å˜ä½å£æ•°ã€ç¾åœ¨ã®ä¾¡é¡ã€æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³ã€ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£** ã¯ã€**ãƒ™ãƒ¼ã‚¹éŠ˜æŸ„å**ãŒåŒã˜ã§ã‚ã‚Œã°ã€**è‡ªå‹•çš„ã«åŒæœŸã•ã‚Œã€æœ€åˆã®é …ç›®ä»¥å¤–ã¯å…¥åŠ›ã§ãã¾ã›ã‚“ã€‚**</ul></div><div id="stocksContainer"></div><br><div class="form-actions"><button id="addStockBtn"type="button"class="nav-button">éŠ˜æŸ„ã‚’è¿½åŠ </button> <button id="saveStocksBtn"class="save-button">è¨­å®šã‚’ä¿å­˜</button></div></div><div class="back-link"><a href="index.html"class="nav-button">ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹</a></div></main></div><script src="app.js"></script><script>// æŒ‡å®šã•ã‚ŒãŸå£åº§ç¨®åˆ¥ã®ãƒªã‚¹ãƒˆ
        const ACCOUNT_TYPES = [
            'ç‰¹å®š',
            'ä¸€èˆ¬',
            'æ—§NISA',
            'ç©ç«‹(æ–°NISA)',
            'æˆé•·(æ–°NISA)',
            'è‡ªç”±å…¥åŠ›' // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®ã€Œè‡ªç”±å…¥åŠ›ã€é …ç›®
        ];

        //ç‚ºæ›¿ãƒšã‚¢ã®ãƒªã‚¹ãƒˆ
        const EXCHANGE_RATES = [
            '',        // ç©ºç™½ï¼ˆç‚ºæ›¿ã®å½±éŸ¿ã‚’å—ã‘ãªã„ãƒ»è€ƒæ…®ã—ãªã„ï¼‰
            'EUR/USD',
            'USD/JPY',
            'EUR/JPY'
        ];


        // æ•°å€¤å…¥åŠ›æ™‚ã«ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã«æ•´å½¢ã™ã‚‹é–¢æ•°
        const formatNumberInput = (event) => {
            const input = event.target;
            let value = input.value.replace(/,/g, '');

            if (isNaN(value) || value === '') {
                input.value = '';
                return;
            }

            const formattedValue = parseInt(value, 10).toLocaleString();
            input.value = formattedValue;
        };

        document.addEventListener('DOMContentLoaded', () => {
            const stocksContainer = document.getElementById('stocksContainer');
            const addStockBtn = document.getElementById('addStockBtn');
            const saveStocksBtn = document.getElementById('saveStocksBtn');

            // éŠ˜æŸ„åã‹ã‚‰å£åº§ç¨®åˆ¥ã‚’é™¤å»ã—ã€ãƒ™ãƒ¼ã‚¹ã®éŠ˜æŸ„åï¼ˆç¨®é¡ï¼‰ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
            const getBaseMeigaraName = (fullMeigara) => {
                if (!fullMeigara) return '';
                // Meigara: "S&P500ï¼œç‰¹å®šï¼" ã®å½¢å¼ã‹ã‚‰ ï¼œç‰¹å®šï¼ ã‚’é™¤å»
                const match = fullMeigara.match(/^(.*)ï¼œ[^ï¼]+ï¼$/);
                return match ? match[1].trim() : fullMeigara.trim();
            };

            // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ MeigaraName ã¨ AccountType ã‚’é€†ç®—ã™ã‚‹é–¢æ•°
            // è‡ªç”±å…¥åŠ›ã®å€¤ã‚‚ã“ã“ã‹ã‚‰æŠ½å‡ºã™ã‚‹
            const parseFullMeigara = (fullMeigara) => {
                if (!fullMeigara) return { MeigaraName: '', AccountType: '', CustomAccountValue: '' };

                const match = fullMeigara.match(/^(.*)ï¼œ([^ï¼]+)ï¼$/);
                if (!match) {
                    return { MeigaraName: fullMeigara.trim(), AccountType: '', CustomAccountValue: '' };
                }

                const meigaraName = match[1].trim();
                const accountTypeInStorage = match[2].trim();

                // æ ¼ç´ã•ã‚Œã¦ã„ã‚‹å£åº§ç¨®åˆ¥ãŒã€å›ºå®šãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (ACCOUNT_TYPES.includes(accountTypeInStorage) && accountTypeInStorage !== 'è‡ªç”±å…¥åŠ›') {
                    // å›ºå®šãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹å ´åˆã¯ã€ãã®ã¾ã¾AccountTypeã¨ã—ã¦è¿”ã™
                    return { MeigaraName: meigaraName, AccountType: accountTypeInStorage, CustomAccountValue: '' };
                } else if (accountTypeInStorage === 'è‡ªç”±å…¥åŠ›') {
                    // æ ¼ç´å€¤ãŒ 'è‡ªç”±å…¥åŠ›' ã®å ´åˆï¼ˆã“ã‚Œã¯æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ç™ºç”Ÿã—ãªã„ãŒäº’æ›æ€§ã®ãŸã‚ï¼‰
                    return { MeigaraName: meigaraName, AccountType: 'è‡ªç”±å…¥åŠ›', CustomAccountValue: '' };
                } else {
                    // æ ¼ç´ã•ã‚Œã¦ã„ã‚‹å£åº§ç¨®åˆ¥ãŒå›ºå®šãƒªã‚¹ãƒˆã«ãªãã€è‡ªç”±å…¥åŠ›ã§ä¿å­˜ã•ã‚ŒãŸã¨è¦‹ãªã™
                    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®é¸æŠã¯ã€Œè‡ªç”±å…¥åŠ›ã€ã«ã—ã€æ ¼ç´ã•ã‚Œã¦ã„ãŸå€¤ã‚’ã‚«ã‚¹ã‚¿ãƒ å€¤ã¨ã—ã¦è¡¨ç¤º
                    return { MeigaraName: meigaraName, AccountType: 'è‡ªç”±å…¥åŠ›', CustomAccountValue: accountTypeInStorage };
                }
            };

            // ã€æ–°æ©Ÿèƒ½ã€‘ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›æ¬„ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
            const toggleCustomAccountInput = (stockItem, initialValue = '') => {
                const select = stockItem.querySelector('.account-type');
                const customGroup = stockItem.querySelector('.custom-account-type-group');
                const customInput = stockItem.querySelector('.custom-account-type-input');

                if (select.value === 'è‡ªç”±å…¥åŠ›') {
                    customGroup.style.display = 'block';
                    customInput.disabled = false;
                    customInput.required = true;
                    // ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸå€¤ã‚’è¨­å®š
                    if (initialValue) {
                        customInput.value = initialValue;
                    }
                } else {
                    customGroup.style.display = 'none';
                    customInput.disabled = true;
                    customInput.required = false;
                }
            };

            // å…¥åŠ›åˆ¶é™ï¼ˆdisabledï¼‰ã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
            const updateInputRestriction = () => {
                const stockItems = document.querySelectorAll('.stock-item');
                const firstBaseMeigaraMap = new Map(); // Key: ãƒ™ãƒ¼ã‚¹éŠ˜æŸ„å, Value: æœ€åˆã«å‡ºç¾ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

                stockItems.forEach((item, index) => {
                    const baseMeigara = item.querySelector('.base-meigara-name').value;

                    // åŒæœŸå¯¾è±¡ã®å…¥åŠ›æ¬„ã‚’ã™ã¹ã¦å–å¾—
                    const syncInputs = item.querySelectorAll('.synchronized-input');

                    if (!baseMeigara) {
                        syncInputs.forEach(input => input.disabled = false);
                        return;
                    }

                    if (!firstBaseMeigaraMap.has(baseMeigara)) {
                        firstBaseMeigaraMap.set(baseMeigara, index);
                        syncInputs.forEach(input => input.disabled = false);
                    } else {
                        syncInputs.forEach(input => input.disabled = true);

                        // ã€åŒæœŸå‡¦ç†ã€‘ç„¡åŠ¹åŒ–ã™ã‚‹å‰ã«ã€æœ€åˆã®éŠ˜æŸ„ã®å€¤ã‚’å–å¾—ã—ã¦å¼·åˆ¶çš„ã«åŒæœŸã™ã‚‹
                        const firstItemIndex = firstBaseMeigaraMap.get(baseMeigara);
                        const firstItem = stockItems[firstItemIndex];

                        syncInputs.forEach(targetInput => {
                            const fieldType = targetInput.dataset.syncField;
                            const sourceInput = firstItem.querySelector(`[data-sync-field="${fieldType}"]`);
                            if (sourceInput) {
                                targetInput.value = sourceInput.value;
                            }
                        });
                    }
                });
            };

            // åŒä¸€éŠ˜æŸ„åã®å…¥åŠ›å€¤ã‚’åŒæœŸã™ã‚‹é–¢æ•° (Inputã‚¤ãƒ™ãƒ³ãƒˆã§å®Ÿè¡Œ)
            const synchronizeInputs = (event) => {
                const changedInput = event.target;
                const isNumeric = changedInput.getAttribute('inputmode') === 'numeric' || changedInput.type === 'number';
                const fieldType = changedInput.dataset.syncField;
                const stockItem = changedInput.closest('.stock-item');
                const baseMeigara = stockItem.querySelector('.base-meigara-name').value;

                if (!baseMeigara) return;
                if (changedInput.disabled) return;

                let newValue = isNumeric
                    ? (changedInput.type === 'text' ? changedInput.value.replace(/,/g, '') : changedInput.value)
                    : changedInput.value;

                // åŒã˜ãƒ™ãƒ¼ã‚¹éŠ˜æŸ„ã‚’æŒã¤ã™ã¹ã¦ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
                document.querySelectorAll('.stock-item').forEach(item => {
                    const itemBaseMeigara = item.querySelector('.base-meigara-name').value;

                    if (itemBaseMeigara === baseMeigara) {
                        const targetInput = item.querySelector(`[data-sync-field="${fieldType}"]`);
                        if (targetInput && targetInput !== changedInput) {
                            targetInput.value = newValue;
                            if (targetInput.type === 'text' && isNumeric) {
                                // ã‚«ãƒ³ãƒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨ã—ç›´ã™
                                const formattedValue = newValue.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                                targetInput.value = formattedValue;
                            }
                        }
                    }
                });


                // å¤‰æ›´å…ƒã®å…¥åŠ›æ¬„ã«ã‚«ãƒ³ãƒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å†é©ç”¨ (æ•°å€¤å…¥åŠ›ã®å ´åˆ)
                if (changedInput.type === 'text' && isNumeric) {
                    changedInput.value = newValue.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                }
            };

            // æ–°ã—ã„éŠ˜æŸ„ã‚¢ã‚¤ãƒ†ãƒ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹é–¢æ•°
            const setupStockItemListeners = (stockItem) => {
                const baseMeigaraInput = stockItem.querySelector('.base-meigara-name');
                const accountTypeSelect = stockItem.querySelector('.account-type');

                // éŠ˜æŸ„åå¤‰æ›´æ™‚ã‚„å£åº§ç¨®åˆ¥å¤‰æ›´æ™‚ã«åˆ¶é™çŠ¶æ…‹ã‚’æ›´æ–°
                baseMeigaraInput.addEventListener('input', updateInputRestriction);
                accountTypeSelect.addEventListener('change', () => {
                    updateInputRestriction();
                    toggleCustomAccountInput(stockItem); // è‡ªç”±å…¥åŠ›æ¬„ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
                });

                // åŒæœŸå¯¾è±¡ã®å…¥åŠ›æ¬„ã«ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                stockItem.querySelectorAll('.synchronized-input').forEach(input => {
                    input.addEventListener('input', synchronizeInputs);
                });

                // æ•°å€¤å…¥åŠ›ã®ã‚«ãƒ³ãƒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                stockItem.querySelectorAll('input[inputmode="numeric"]').forEach(input => {
                    input.addEventListener('input', formatNumberInput);
                });
            };

            // createStockItem é–¢æ•°ã®ä¿®æ­£: MeigaraNameã¨AccountTypeã‚’åˆ†é›¢
            const createStockItem = (index, stockData = {}) => {
                const stockItem = document.createElement('div');
                stockItem.classList.add('stock-item');

                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ MeigaraName, AccountType, CustomAccountValue ã‚’åˆ†é›¢
                const { MeigaraName: baseMeigara, AccountType: accountType, CustomAccountValue: customAccountValue } = parseFullMeigara(stockData.Meigara);

                // éŠ˜æŸ„åãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°ã€ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å€¤ã‚’ã‚«ãƒ³ãƒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¦ã‹ã‚‰è¡¨ç¤º
                const formatIfNumeric = (key) => {
                    const value = stockData[key];
                    // æ•°å€¤ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’toLocaleStringã§ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã«ã™ã‚‹
                    return value !== undefined && value !== null && !isNaN(value) ? value.toLocaleString() : '';
                };


                // ç‚ºæ›¿ãƒšã‚¢ã®åˆæœŸå€¤ã‚’å–å¾—
                const exchangeRate = stockData.ExchangeRate || '';
                const exchangeOptions = EXCHANGE_RATES.map(rate => 
                    `<option value="${rate}" ${rate === exchangeRate ? 'selected' : ''}>${rate === '' ? 'ç©ºç™½ï¼ˆç‚ºæ›¿ã®å½±éŸ¿ã‚’å—ã‘ãªã„ï¼‰' : rate}</option>`
                ).join('');


                // å£åº§ç¨®åˆ¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
                const accountOptions = ACCOUNT_TYPES.map(type =>
                    `<option value="${type}" ${type === accountType ? 'selected' : ''}>${type}</option>`
                ).join('');

                // è‡ªç”±å…¥åŠ›æ¬„ã®åˆæœŸè¡¨ç¤ºçŠ¶æ…‹ã‚’æ±ºå®š
                const isCustomAccount = accountType === 'è‡ªç”±å…¥åŠ›';
                const customInputDisplay = isCustomAccount ? 'block' : 'none';

                stockItem.innerHTML = `
                    <h3>éŠ˜æŸ„ ${index + 1}</h3>
                    
                    <div class="meigara-group">
                        <div class="form-group" style="flex: 2;">
                            <label>ãƒ™ãƒ¼ã‚¹éŠ˜æŸ„å:</label>
                            <input type="text" class="base-meigara-name" value="${baseMeigara}" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>å£åº§ç¨®åˆ¥:</label>
                            <select class="account-type" required>
                                <option value="" disabled ${!accountType ? 'selected' : ''}>é¸æŠã—ã¦ãã ã•ã„</option>
                                ${accountOptions}
                            </select>
                        </div>
                    </div>
                    
                    <div class="custom-account-type-group" style="display: ${customInputDisplay}; margin-bottom: 15px;">
                        <label>è‡ªç”±å…¥åŠ›ï¼ˆå£åº§åï¼‰:</label>
                        <input type="text" class="custom-account-type-input" placeholder="ä»»æ„ã®å£åº§åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" value="${customAccountValue}" ${isCustomAccount ? '' : 'disabled'}>
                    </div>

                    <!-- ç‚ºæ›¿ -->
                    <div class="form-group">
                        <label for="exchangeRate_${index}">ç‚ºæ›¿ãƒšã‚¢:</label>
                        <select id="exchangeRate_${index}" class="exchange-rate-select synchronized-input" data-sync-field="ExchangeRate" required>${exchangeOptions}</select>
                    </div>

                    <div class="form-group">
                        <label>ä¿æœ‰å£æ•°:</label>
                        <input type="text" class="kuchisu-input" value="${formatIfNumeric('Kuchisu')}" inputmode="numeric" pattern="[0-9,]*" required>
                    </div>
                    <div class="form-group">
                        <label>å˜ä½å£æ•°:</label>
                        <input type="text" class="tani-input synchronized-input" data-sync-field="Tani" value="${formatIfNumeric('Tani')}" inputmode="numeric" pattern="[0-9,]*" required>
                    </div>
                    <div class="form-group">
                        <label>å˜ä½å£æ•°å½“ãŸã‚Šã®ç¾åœ¨ã®ä¾¡é¡ï¼ˆå††ï¼‰:</label>
                        <input type="text" class="current-value-input synchronized-input" data-sync-field="CurrentValuePerUnit" value="${formatIfNumeric('CurrentValuePerUnit')}" inputmode="numeric" pattern="[0-9,]*" required>
                    </div>
                    <div class="form-group">
                        <label>å¹³å‡å–å¾—ä¾¡é¡ï¼ˆå††ï¼‰:</label>
                        <input type="text" class="average-price-input" value="${formatIfNumeric('AveragePrice')}" inputmode="numeric" pattern="[0-9,]*" required>
                    </div>
                    <div class="form-group">
                        <label>æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆå¹´ç‡%ï¼‰:</label>
                        <input type="number" step="0.01" class="return-input synchronized-input" data-sync-field="Return" value="${stockData.Return || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆå¹´ç‡%ï¼‰:</label>
                        <input type="number" step="0.01" class="volatility-input synchronized-input" data-sync-field="Volatility" value="${stockData.Volatility || ''}" required>
                    </div>
                    <div class="form-group tax-start-group">
            			<label for="month-input">ç¨é‡‘é–‹å§‹æ™‚æœŸï¼ˆå¹´æœˆï¼‰:</label>
            			<input type="month" class="tax-from-month-input" name="selected-from-month"  value="${stockData.fromMonth || ''}">
                        <p style="font-size: 12px; color: #888; margin-left: 10px;">
                            æ–°NISAæˆé•·ãƒ»æ–°NISAç©ã¿ç«‹ã¦:ç©ºæ¬„ã«ã—ã¦ãã ã•ã„ã€‚<br>
                        </p>
                    </div>

                    <button type="button" class="remove-stock-btn">ã“ã®éŠ˜æŸ„ã‚’å‰Šé™¤</button>
                `;

                stockItem.querySelector('.remove-stock-btn').addEventListener('click', () => {
                    stockItem.remove();
                    updateStockNumbers();
                    updateInputRestriction(); // å‰Šé™¤å¾Œã‚‚åˆ¶é™çŠ¶æ…‹ã‚’æ›´æ–°
                });

                // æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã«ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                setupStockItemListeners(stockItem);
                // ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸè¡¨ç¤ºåˆ¶å¾¡
                toggleCustomAccountInput(stockItem, customAccountValue);

                return stockItem;
            };

            const updateStockNumbers = () => {
                const stockItems = document.querySelectorAll('.stock-item');
                stockItems.forEach((item, index) => {
                    item.querySelector('h3').textContent = `éŠ˜æŸ„ ${index + 1}`;
                });
            };

            const loadStocks = () => {
                const appData = JSON.parse(localStorage.getItem('fireSimulatorData')) || {};
                const stocks = appData.stocks || [];
                stocksContainer.innerHTML = '';
                if (stocks.length > 0) {
                    stocks.forEach((stock, index) => {
                        const stockItem = createStockItem(index, stock);
                        stocksContainer.appendChild(stockItem);
                    });
                } else {
                    addStock();
                }
                updateStockNumbers();
                updateInputRestriction(); // ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã«åˆ¶é™çŠ¶æ…‹ã‚’é©ç”¨
            };

            const addStock = () => {
                const index = stocksContainer.children.length;
                const stockItem = createStockItem(index);
                stocksContainer.appendChild(stockItem);
                updateStockNumbers();
                updateInputRestriction(); // è¿½åŠ å¾Œã‚‚åˆ¶é™çŠ¶æ…‹ã‚’æ›´æ–°
            };
            addStockBtn.addEventListener('click', () => addStock());

            saveStocksBtn.addEventListener('click', () => {
                const stocksData = [];
                let isValid = true;
                document.querySelectorAll('.stock-item').forEach(item => {
                    const baseMeigaraName = item.querySelector('.base-meigara-name').value.trim();
                    const accountTypeSelect = item.querySelector('.account-type');
                    const selectedAccountType = accountTypeSelect.value.trim();
                    const customAccountInput = item.querySelector('.custom-account-type-input');

                    let finalAccountType;

                    // æœ€çµ‚çš„ã«ä¿å­˜ã™ã‚‹å£åº§ç¨®åˆ¥ã‚’æ±ºå®š
                    if (selectedAccountType === 'è‡ªç”±å…¥åŠ›') {
                        // ã€Œè‡ªç”±å…¥åŠ›ã€ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›æ¬„ã®å€¤ã‚’ä½¿ç”¨
                        finalAccountType = customAccountInput.value.trim();
                    } else {
                        // å›ºå®šãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã®å€¤ã‚’ä½¿ç”¨
                        finalAccountType = selectedAccountType;
                    }

                    // æœ€çµ‚çš„ã«ä¿å­˜ã™ã‚‹Meigaraï¼ˆsimulate.htmlãŒæœŸå¾…ã™ã‚‹å½¢å¼ï¼‰ã‚’ç”Ÿæˆ
                    const fullMeigara = `${baseMeigaraName}ï¼œ${finalAccountType}ï¼`;

                    const kuchisuValue = item.querySelector('.kuchisu-input').value;
                    const taniValue = item.querySelector('.tani-input').value;
                    const currentValueValue = item.querySelector('.current-value-input').value;
                    const averagePriceValue = item.querySelector('.average-price-input').value;
                    const returnRate = item.querySelector('.return-input').value;
                    const volatility = item.querySelector('.volatility-input').value;
                    const fromMonth = item.querySelector('.tax-from-month-input');
                    //ç‚ºæ›¿ãƒšã‚¢ã®å€¤ã‚’å–å¾—
                    const exchangeRate = item.querySelector('.exchange-rate-select').value;

                    // ã‚«ãƒ³ãƒã‚’é™¤å»ã—ã¦æ•°å€¤ã«å¤‰æ›
                    const kuchisu = parseInt(kuchisuValue.replace(/,/g, ''), 10);
                    const tani = parseInt(taniValue.replace(/,/g, ''), 10);
                    const currentValuePerUnit = parseInt(currentValueValue.replace(/,/g, ''), 10);
                    const averagePrice = parseInt(averagePriceValue.replace(/,/g, ''), 10);

                    let taxStartYear = null;
                    let taxStartMonth = null;

                    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
                    if (!baseMeigaraName || !finalAccountType || isNaN(kuchisu) || isNaN(tani) || isNaN(currentValuePerUnit) || isNaN(averagePrice) || isNaN(parseFloat(returnRate)) || isNaN(parseFloat(volatility)) || kuchisu < 0 || tani <= 0 || currentValuePerUnit <= 0 || averagePrice < 0 || parseFloat(returnRate) < -100 || parseFloat(volatility) < 0) {
                        alert('å…¨ã¦ã®é …ç›®ã«æ­£ã—ã„æ•°å€¤ã‚’å…¥åŠ›/é¸æŠã—ã¦ãã ã•ã„ã€‚éŠ˜æŸ„åã¾ãŸã¯å£åº§ç¨®åˆ¥ãŒç©ºæ¬„ã§ã™ã€‚');
                        isValid = false;
                        return;
                    }

                    let w_fromMonth = null;
                    if (fromMonth.value.trim() !== "") {
                        w_fromMonth = fromMonth.value.trim();
                        let w = parseInt(compareMonthAndGetCurrent(w_fromMonth), 10);
                        taxStartYear = Math.floor(w / 12);
                        taxStartMonth = (w % 12);
                    }
                    //æ–°NISAä»¥å¤–ã§ã€ç¨é‡‘é–‹å§‹å¹´æœˆæ—¥ãŒå…¥ã£ã¦ã„ãªã„ã¨ãã¯ã€æœ€åˆã‹ã‚‰ç¨é‡‘ã‚’é©ç”¨
                    else if (finalAccountType !== "ç©ç«‹(æ–°NISA)" && finalAccountType !== "æˆé•·(æ–°NISA)") {
                        taxStartYear = 0;
                        taxStartMonth = 0;
                    }

                    stocksData.push({
                        Meigara: fullMeigara, // simulate.htmlãŒæœŸå¾…ã™ã‚‹å½¢å¼
                        Kuchisu: kuchisu,
                        Tani: tani,
                        CurrentValuePerUnit: currentValuePerUnit,
                        AveragePrice: averagePrice,
                        Return: parseFloat(returnRate),
                        Volatility: parseFloat(volatility),
                        TaxStartYear: taxStartYear,
                        TaxStartMonth: taxStartMonth,
                        fromMonth: w_fromMonth,
                        ExchangeRate: exchangeRate  //ç‚ºæ›¿
                    });
                });

                if (!isValid) {
                    return;
                }

                const appData = JSON.parse(localStorage.getItem('fireSimulatorData')) || {};
                appData.stocks = stocksData;
                localStorage.setItem('fireSimulatorData', JSON.stringify(appData));
                alert('ä¿æœ‰è¨¼åˆ¸ã®è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');

                // ä¿å­˜å¾Œã€å†è¡¨ç¤ºã¨å†åˆ¶é™
                loadStocks();
            });

            loadStocks();
        });</script>