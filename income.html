<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>収入設定</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>収入設定</h1>
            <p>毎月の収入イベントを設定します。</p>
        </header>

        <main>
            <div class="input-section">
                <h2>収入イベント一覧</h2>
                <div class="instruction-box">
                    <p><strong>💡 入力方法:</strong></p>
                    <ul>
                        <li><strong>開始年/月:</strong> 収入が発生し始めるタイミングを設定します。</li>
                        <li><strong>終了年/月:</strong> 収入が終了するタイミングを設定します。</li>
                        <li><strong>終了年/月が空欄:</strong> 開始年/月からシミュレーション期間の終わりまで、毎月収入が発生し続けます。</li>
                        <li><strong>0年0月または0年1月:</strong> どちらも「シミュレーション開始月」を意味します。</li>
                    </ul>
                </div>
                <div id="incomeContainer">
                    </div>
                <div class="form-actions">
                    <button id="addIncomeBtn" type="button">収入を追加</button>
                    <button id="saveIncomeBtn" class="save-button">設定を保存</button>
                </div>
            </div>

            <div class="back-link">
                <a href="index.html" class="nav-button">メイン画面に戻る</a>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const incomeContainer = document.getElementById('incomeContainer');
            const addIncomeBtn = document.getElementById('addIncomeBtn');
            const saveIncomeBtn = document.getElementById('saveIncomeBtn');

            const createIncomeItem = (index, incomeData = {}) => {
                const incomeItem = document.createElement('div');
                incomeItem.classList.add('income-item');
                incomeItem.innerHTML = `
                    <h3>収入イベント ${index + 1}</h3>
                    <div class="form-group input-group">
                        <label>開始年/月:</label>
                        <input type="number" class="income-start-year" placeholder="年" value="${incomeData.startTotalMonths !== undefined ? Math.floor(incomeData.startTotalMonths / 12) : ''}" required>
                        <span>年</span>
                        <input type="number" class="income-start-month" placeholder="月" value="${incomeData.startTotalMonths !== undefined ? (incomeData.startTotalMonths % 12) + 1 : ''}" required>
                        <span>月</span>
                    </div>
                    <div class="form-group input-group">
                        <label>終了年/月:</label>
                        <input type="number" class="income-end-year" placeholder="年" value="${incomeData.endTotalMonths !== null && incomeData.endTotalMonths !== undefined ? Math.floor(incomeData.endTotalMonths / 12) : ''}">
                        <span>年</span>
                        <input type="number" class="income-end-month" placeholder="月" value="${incomeData.endTotalMonths !== null && incomeData.endTotalMonths !== undefined ? (incomeData.endTotalMonths % 12) + 1 : ''}">
                        <span>月</span>
                    </div>
                    <div class="form-group">
                        <label>収入額（円/月）:</label>
                        <input type="text" class="income-amount" value="${incomeData.amount || ''}" inputmode="numeric" pattern="[0-9,]*" required>
                    </div>
                    <div class="form-group">
                        <label>理由（任意）:</label>
                        <input type="text" class="income-reason" value="${incomeData.reason || ''}">
                    </div>
                    <button type="button" class="remove-btn">削除</button>
                `;
                
                incomeItem.querySelector('.remove-btn').addEventListener('click', () => {
                    incomeItem.remove();
                    updateIncomeNumbers();
                });

                return incomeItem;
            };

            const updateIncomeNumbers = () => {
                const items = document.querySelectorAll('.income-item');
                items.forEach((item, index) => {
                    item.querySelector('h3').textContent = `収入イベント ${index + 1}`;
                });
            };

            const loadIncomes = () => {
                const appData = JSON.parse(localStorage.getItem('fireSimulatorData')) || {};
                const income = appData.income || [];
                incomeContainer.innerHTML = '';
                if (income.length > 0) {
                    income.forEach((data, index) => {
                        incomeContainer.appendChild(createIncomeItem(index, data));
                    });
                } else {
                    incomeContainer.appendChild(createIncomeItem(0));
                }
                updateIncomeNumbers();
                document.querySelectorAll('input[inputmode="numeric"]').forEach(input => {
                    if (input.value) {
                        const value = input.value.replace(/,/g, '');
                        input.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    }
                    input.addEventListener('input', formatNumberInput);
                });
            };

            addIncomeBtn.addEventListener('click', () => {
                const index = incomeContainer.children.length;
                const newIncomeItem = createIncomeItem(index);
                incomeContainer.appendChild(newIncomeItem);
                updateIncomeNumbers();
                newIncomeItem.querySelectorAll('input[inputmode="numeric"]').forEach(input => {
                    input.addEventListener('input', formatNumberInput);
                });
            });

            saveIncomeBtn.addEventListener('click', () => {
                const incomeData = [];
                let isValid = true;
                
                document.querySelectorAll('.income-item').forEach(item => {
                    const startYearInput = item.querySelector('.income-start-year');
                    const startMonthInput = item.querySelector('.income-start-month');
                    const endYearInput = item.querySelector('.income-end-year');
                    const endMonthInput = item.querySelector('.income-end-month');
                    const amountInput = item.querySelector('.income-amount');
                    const reasonInput = item.querySelector('.income-reason');

                    const startYear = parseInt(startYearInput.value, 10);
                    const startMonth = parseInt(startMonthInput.value, 10);
                    const amount = parseInt(amountInput.value.replace(/,/g, ''), 10);
                    const reason = reasonInput.value;
                    
                    let endYear = endYearInput.value ? parseInt(endYearInput.value, 10) : null;
                    let endMonth = endMonthInput.value ? parseInt(endMonthInput.value, 10) : null;

                    if (startYear === 0 && startMonth === 0) {
                        startMonth = 1;
                    }
                    if (endYear === 0 && endMonth === 0) {
                        endMonth = 1;
                    }

                    if (isNaN(startYear) || isNaN(startMonth) || startYear < 0 || startMonth < 1 || startMonth > 12) {
                        alert('開始年/月は正しい数値を入力してください。');
                        isValid = false;
                        startYearInput.classList.add('error-input');
                        startMonthInput.classList.add('error-input');
                        return;
                    }
                    if ((endYear !== null && isNaN(endYear)) || (endMonth !== null && isNaN(endMonth))) {
                        alert('終了年/月は正しい数値を入力するか、両方空欄にしてください。');
                        isValid = false;
                        endYearInput.classList.add('error-input');
                        endMonthInput.classList.add('error-input');
                        return;
                    }
                    if ((endYear === null && endMonth !== null) || (endYear !== null && endMonth === null)) {
                        alert('終了年/月は両方入力するか、両方空欄にしてください。');
                        isValid = false;
                        endYearInput.classList.add('error-input');
                        endMonthInput.classList.add('error-input');
                        return;
                    }

                    const startTotalMonths = startYear * 12 + (startMonth - 1);
                    const endTotalMonths = (endYear !== null && endMonth !== null) ? endYear * 12 + (endMonth - 1) : null;
                    
                    if (endTotalMonths !== null && startTotalMonths > endTotalMonths) {
                         alert('開始年/月は終了年/月よりも前の月に設定してください。');
                         isValid = false;
                         startYearInput.classList.add('error-input');
                         startMonthInput.classList.add('error-input');
                         endYearInput.classList.add('error-input');
                         endMonthInput.classList.add('error-input');
                         return;
                    }

                    startYearInput.classList.remove('error-input');
                    startMonthInput.classList.remove('error-input');
                    endYearInput.classList.remove('error-input');
                    endMonthInput.classList.remove('error-input');

                    incomeData.push({
                        startTotalMonths: startTotalMonths,
                        endTotalMonths: endTotalMonths,
                        amount: amount,
                        reason: reason
                    });
                });

                if (!isValid) {
                    return;
                }

                const appData = JSON.parse(localStorage.getItem('fireSimulatorData')) || {};
                appData.income = incomeData.sort((a, b) => a.startTotalMonths - b.startTotalMonths);
                localStorage.setItem('fireSimulatorData', JSON.stringify(appData));
                alert('収入の設定が保存されました！');
            });

            loadIncomes();
        });
    </script>
</body>
</html>